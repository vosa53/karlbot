var karel;(()=>{"use strict";var t,e,i,n,r={d:(t,e)=>{for(var i in e)r.o(e,i)&&!r.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},s={};r.r(s),r.d(s,{AddInstruction:()=>c,AmbiguousSymbol:()=>C,Assembly:()=>a,BlockNode:()=>Rt,BlockPrimitiveNode:()=>Wt,CallExternalInstruction:()=>u,CallInstruction:()=>d,CallNode:()=>F,CallPrimitiveNode:()=>R,CallStackFrame:()=>At,Checker:()=>ot,CodeFile:()=>Yt,CompareGreaterInstruction:()=>m,Compilation:()=>U,CompilationUnitNode:()=>Bt,CompilationUnitParser:()=>Dt,CompilationUnitPrimitiveNode:()=>Mt,CompletionItem:()=>rt,CompletionItemType:()=>e,DataType:()=>t,ElsePrimitiveToken:()=>dt,ElseToken:()=>ut,Emitter:()=>et,EndOfFilePrimitiveToken:()=>lt,EndOfFileToken:()=>at,EndOfLineTrivia:()=>zt,Error:()=>nt,Event:()=>o,Exception:()=>Vt,ExceptionInterpretResult:()=>Jt,ExternalProgram:()=>jt,ExternalProgramReference:()=>D,ExternalProgramSymbol:()=>y,File:()=>Qt,FullLexerContext:()=>ht,FullParserContext:()=>ct,IdentifierPrimitiveToken:()=>Tt,IdentifierToken:()=>gt,IfNode:()=>A,IfPrimitiveNode:()=>V,IfPrimitiveToken:()=>kt,IfToken:()=>wt,Instruction:()=>h,InterpretStopToken:()=>Ht,Interpreter:()=>Zt,InvalidCharactersTrivia:()=>K,IsPrimitiveToken:()=>tt,IsToken:()=>Y,JumpIfFalseInstruction:()=>p,JumpIfTrueInstruction:()=>g,JumpInstruction:()=>T,LanguageService:()=>st,Lexer:()=>Ft,LineTextRange:()=>P,LoadInstruction:()=>w,MultilineCommentTrivia:()=>Lt,MutableTown:()=>ee,Node:()=>q,NormalInterpretResult:()=>Xt,NotPrimitiveToken:()=>vt,NotToken:()=>ft,NumberPrimitiveToken:()=>Ct,NumberToken:()=>xt,Parser:()=>Ut,PopInstruction:()=>k,PrimitiveNode:()=>O,PrimitiveSyntaxElement:()=>L,PrimitiveToken:()=>Q,Program:()=>l,ProgramNode:()=>W,ProgramPrimitiveNode:()=>B,ProgramPrimitiveToken:()=>bt,ProgramSymbol:()=>b,ProgramToken:()=>yt,Project:()=>ie,ProjectDeserializer:()=>se,ProjectSerializer:()=>oe,PushInstruction:()=>f,Rectangle:()=>Kt,RepeatNode:()=>j,RepeatPrimitiveNode:()=>H,RepeatPrimitiveToken:()=>St,RepeatToken:()=>It,Settings:()=>ne,SinglelineCommentTrivia:()=>qt,SkippedTokenTrivia:()=>Z,StandardLibrary:()=>Ce,StopInterpretResult:()=>Gt,StoreInstruction:()=>v,SymbolTable:()=>M,Symbol_:()=>x,SyntaxElement:()=>z,SyntaxError:()=>S,TextRange:()=>N,TimesPrimitiveToken:()=>_t,TimesToken:()=>Pt,Token:()=>$,Town:()=>te,TownDirection:()=>i,TownDirectionUtils:()=>ae,TownFile:()=>re,TownTile:()=>n,Trivia:()=>X,Vector:()=>$t,WhileNode:()=>J,WhilePrimitiveNode:()=>G,WhilePrimitiveToken:()=>Nt,WhileToken:()=>Et,WhitespaceTrivia:()=>Ot,east:()=>we,isHome:()=>ke,north:()=>pe,pick:()=>ce,put:()=>ue,sign:()=>me,south:()=>ge,step:()=>le,turnLeft:()=>he,wall:()=>de,west:()=>Te});class o{constructor(){this.listeners=[]}emit(){for(const t of this.listeners)t()}addListener(t){this.listeners.push(t)}removeListener(t){const e=this.listeners.indexOf(t);-1!==e&&this.listeners.splice(e,1)}}class a{constructor(t){this.programs=t}}class l{constructor(t,e,i){this.name=t,this.instructions=e,this.variableCount=i}}class h{}class c extends h{}class u extends h{constructor(t){super(),this.name=t}}class d extends h{constructor(t){super(),this.program=t}}class m extends h{}class p extends h{constructor(t){super(),this.instructionIndex=t}}class g extends h{constructor(t){super(),this.instructionIndex=t}}class T extends h{constructor(t){super(),this.instructionIndex=t}}class w extends h{constructor(t){super(),this.localIndex=t}}class k extends h{}class f extends h{constructor(t){super(),this.value=t}}class v extends h{constructor(t){super(),this.localIndex=t}}class x{}class C extends x{constructor(t){super(),this.candidates=t}}class y extends x{constructor(t){super(),this.externalProgram=t}}class b extends x{constructor(t){super(),this.definition=t}}class I{static equalsOrBothNull(t,e){return null===t&&null===e||null!==t&&null!==e&&t.equals(e)}}class S{constructor(t,e){this.message=t,this.textRange=e}}class P{constructor(t,e,i,n){this.startLine=t,this.startColumn=e,this.endLine=i,this.endColumn=n}}class _{constructor(){this._children=[],this._syntaxErrors=[],this._length=0,this._lineCount=1,this._lastLineLength=0}get children(){return this._children}get syntaxErrors(){return this._syntaxErrors}get length(){return this._length}get lineCount(){return this._lineCount}get lastLineLength(){return this._lastLineLength}addChild(t){this._children.push(t),this._length+=t.length,this._lineCount+=t.lineCount-1,this._lastLineLength=t.lineCount>1?t.lastLineLength:this._lastLineLength+t.length}addChildOrError(t,e){if(null!==t)this.addChild(t);else{const t=new P(this._lineCount,this._lastLineLength+1,this._lineCount,this._lastLineLength+2),i=new S(e,t);this._syntaxErrors.push(i)}}}class E{static equals(t,e,i){if(t.length!==e.length)return!1;for(let n=0;n<t.length;n++)if(!i(t[n],e[n]))return!1;return!0}}class N{constructor(t,e){this.position=t,this.length=e}}class z{get length(){return this.primitive.length}get lineCount(){return this.primitive.lineCount}get lastLineLength(){return this.primitive.lastLineLength}get endLine(){return this.startLine+this.primitive.lineCount-1}get endColumn(){return this.primitive.lineCount>1?this.primitive.lastLineLength+1:this.startColumn+this.primitive.length}constructor(t,e,i,n,r){this.primitive=t,this.parent=e,this.position=i,this.startLine=n,this.startColumn=r}getTextRange(){return new N(this.position,this.length)}getLineTextRange(){return new P(this.startLine,this.startColumn,this.endLine,this.endColumn)}buildText(){return this.primitive.buildText()}}class L{constructor(t,e,i,n){this.length=t,this.lineCount=e,this.lastLineLength=i,this.syntaxErrors=n}buildText(){const t=[];return this.pushText(t),t.join("")}}class q extends z{get children(){return void 0===this._children&&this.initializeChildren(),this._children}constructor(t,e,i,n,r){super(t,e,i,n,r),this._children=void 0}getTextRangeWithoutTrivia(){return this.getTextRange()}getLineTextRangeWithoutTrivia(){return this.getLineTextRange()}initializeChildren(){this._children=[];let t=this.position,e=this.startLine,i=this.startColumn;const n=this.primitive;for(const r of n.children){const n=r.createWrapper(this,t,e,i);this._children.push(n),t+=r.length,e+=r.lineCount-1,i=r.lineCount>1?r.lastLineLength+1:i+r.length}}}class O extends L{constructor(t){super(t.length,t.lineCount,t.lastLineLength,t.syntaxErrors),this.children=t.children}equals(t){return t instanceof O&&E.equals(this.children,t.children,((t,e)=>t.equals(e)))}pushText(t){for(const e of this.children)e.pushText(t)}}class F extends q{get nameToken(){return void 0===this._nameToken&&this.initialize(),this._nameToken}constructor(t,e,i,n,r){super(t,e,i,n,r),this._nameToken=void 0}with(t){const e=this.primitive;return new R(void 0===t.nameToken?e.nameToken:t.nameToken?.primitive??null).createWrapper(null,0,1,1)}initialize(){const t=this.primitive;this._nameToken=null!==t.nameToken?this.children[0]:null}}class R extends O{constructor(t){super(R.createChildren(t)),this.nameToken=t}equals(t){return super.equals(t)&&t instanceof R&&I.equalsOrBothNull(this.nameToken,t.nameToken)}createWrapper(t,e,i,n){return new F(this,t,e,i,n)}static createChildren(t){const e=new _;return e.addChildOrError(t,"Missing name token"),e}}class W extends q{get programToken(){return void 0===this._programToken&&this.initialize(),this._programToken}get nameToken(){return void 0===this._nameToken&&this.initialize(),this._nameToken}get body(){return void 0===this._body&&this.initialize(),this._body}constructor(t,e,i,n,r){super(t,e,i,n,r),this._programToken=void 0,this._nameToken=void 0,this._body=void 0}with(t){const e=this.primitive;return new B(void 0===t.programToken?e.programToken:t.programToken?.primitive??null,void 0===t.nameToken?e.nameToken:t.nameToken?.primitive??null,void 0===t.body?e.body:t.body?.primitive??null).createWrapper(null,0,1,1)}initialize(){const t=this.primitive;let e=0;this._programToken=null!==t.programToken?this.children[e]:null,e+=null!==t.programToken?1:0,this._nameToken=null!==t.nameToken?this.children[e]:null,e+=null!==t.nameToken?1:0,this._body=null!==t.body?this.children[e]:null}}class B extends O{constructor(t,e,i){super(B.createChildren(t,e,i)),this.programToken=t,this.nameToken=e,this.body=i}equals(t){return super.equals(t)&&t instanceof B&&I.equalsOrBothNull(this.programToken,t.programToken)&&I.equalsOrBothNull(this.nameToken,t.nameToken)&&I.equalsOrBothNull(this.body,t.body)}createWrapper(t,e,i,n){return new W(this,t,e,i,n)}static createChildren(t,e,i){const n=new _;return n.addChildOrError(t,"Missing program token"),n.addChildOrError(e,"Missing name token"),n.addChildOrError(i,"Missing body"),n}}class M{constructor(t,e,i){this.definedSymbols=t,this.programToSymbol=e,this.nameToSymbol=i}static create(t,e){const i=[],n=new Map,r=new Map,s=new Map;for(const e of t)for(const t of e.programs){const e=new b(t);if(i.push(e),n.set(t,e),null!==t.nameToken){let i=s.get(t.nameToken.text);void 0===i&&(i=[],s.set(t.nameToken.text,i)),i.push(e)}}for(const t of e){const e=new y(t);i.push(e);let n=s.get(t.name);void 0===n&&(n=[],s.set(t.name,n)),n.push(e)}for(const t of s){const e=1===t[1].length?t[1][0]:new C(t[1]);r.set(t[0],e)}return new M(i,n,r)}getDefined(){return this.definedSymbols}getByNode(t){return t instanceof F&&null!==t.nameToken?this.nameToSymbol.get(t.nameToken.text)||null:t instanceof W&&this.programToSymbol.get(t)||null}getByName(t){return this.nameToSymbol.get(t)||null}}class U{get symbolTable(){return this._symbolTable=this._symbolTable??M.create(this.compilationUnits,this.externalPrograms)}constructor(t,e){this._symbolTable=null,this.compilationUnits=t,this.externalPrograms=e}addCompilationUnit(t){const e=[...this.compilationUnits,t];return new U(e,this.externalPrograms)}removeCompilationUnit(t){const e=this.compilationUnits.indexOf(t);if(-1===e)return this;const i=[...this.compilationUnits];return i.splice(e,1),new U(i,this.externalPrograms)}replaceCompilationUnit(t,e){const i=this.compilationUnits.indexOf(t);if(-1===i)return this;const n=[...this.compilationUnits];return n[i]=e,new U(n,this.externalPrograms)}withExternalPrograms(t){return new U(this.compilationUnits,t)}}!function(t){t[t.unit=0]="unit",t[t.number=1]="number"}(t||(t={}));class D{constructor(t,e){this.name=t,this.returnType=e}}class A extends q{get ifToken(){return void 0===this._ifToken&&this.initialize(),this._ifToken}get operationToken(){return void 0===this._operationToken&&this.initialize(),this._operationToken}get condition(){return void 0===this._condition&&this.initialize(),this._condition}get body(){return void 0===this._body&&this.initialize(),this._body}get elseToken(){return void 0===this._elseToken&&this.initialize(),this._elseToken}get elseBody(){return void 0===this._elseBody&&this.initialize(),this._elseBody}constructor(t,e,i,n,r){super(t,e,i,n,r),this._ifToken=void 0,this._operationToken=void 0,this._condition=void 0,this._body=void 0,this._elseToken=void 0,this._elseBody=void 0}with(t){const e=this.primitive;return new V(void 0===t.ifToken?e.ifToken:t.ifToken?.primitive??null,void 0===t.operationToken?e.operationToken:t.operationToken?.primitive??null,void 0===t.condition?e.condition:t.condition?.primitive??null,void 0===t.body?e.body:t.body?.primitive??null,void 0===t.elseToken?e.elseToken:t.elseToken?.primitive??null,void 0===t.elseBody?e.elseBody:t.elseBody?.primitive??null).createWrapper(null,0,1,1)}initialize(){const t=this.primitive;let e=0;this._ifToken=null!==t.ifToken?this.children[e]:null,e+=null!==t.ifToken?1:0,this._operationToken=null!==t.operationToken?this.children[e]:null,e+=null!==t.operationToken?1:0,this._condition=null!==t.condition?this.children[e]:null,e+=null!==t.condition?1:0,this._body=null!==t.body?this.children[e]:null,e+=null!==t.body?1:0,this._elseToken=null!==t.elseToken?this.children[e]:null,e+=null!==t.elseToken?1:0,this._elseBody=null!==t.elseBody?this.children[e]:null}}class V extends O{constructor(t,e,i,n,r,s){super(V.createChildren(t,e,i,n,r,s)),this.ifToken=t,this.operationToken=e,this.condition=i,this.body=n,this.elseToken=r,this.elseBody=s}equals(t){return super.equals(t)&&t instanceof V&&I.equalsOrBothNull(this.ifToken,t.ifToken)&&I.equalsOrBothNull(this.operationToken,t.operationToken)&&I.equalsOrBothNull(this.condition,t.condition)&&I.equalsOrBothNull(this.body,t.body)&&I.equalsOrBothNull(this.elseToken,t.elseToken)&&I.equalsOrBothNull(this.elseBody,t.elseBody)}createWrapper(t,e,i,n){return new A(this,t,e,i,n)}static createChildren(t,e,i,n,r,s){const o=new _;return o.addChildOrError(t,"Missing if token"),o.addChildOrError(e,"Missing operation token"),o.addChildOrError(i,"Missing condition"),o.addChildOrError(n,"Missing body"),null!=r?(o.addChild(r),o.addChildOrError(s,"Missing else body")):null!=s&&o.addChild(s),o}}class j extends q{get repeatToken(){return void 0===this._repeatToken&&this.initialize(),this._repeatToken}get countToken(){return void 0===this._countToken&&this.initialize(),this._countToken}get timesToken(){return void 0===this._timesToken&&this.initialize(),this._timesToken}get body(){return void 0===this._body&&this.initialize(),this._body}constructor(t,e,i,n,r){super(t,e,i,n,r),this._repeatToken=void 0,this._countToken=void 0,this._timesToken=void 0,this._body=void 0}with(t){const e=this.primitive;return new H(void 0===t.repeatToken?e.repeatToken:t.repeatToken?.primitive??null,void 0===t.countToken?e.countToken:t.countToken?.primitive??null,void 0===t.timesToken?e.timesToken:t.timesToken?.primitive??null,void 0===t.body?e.body:t.body?.primitive??null).createWrapper(null,0,1,1)}initialize(){const t=this.primitive;let e=0;this._repeatToken=null!==t.repeatToken?this.children[e]:null,e+=null!==t.repeatToken?1:0,this._countToken=null!==t.countToken?this.children[e]:null,e+=null!==t.countToken?1:0,this._timesToken=null!==t.timesToken?this.children[e]:null,e+=null!==t.timesToken?1:0,this._body=null!==t.body?this.children[e]:null}}class H extends O{constructor(t,e,i,n){super(H.createChildren(t,e,i,n)),this.repeatToken=t,this.countToken=e,this.timesToken=i,this.body=n}equals(t){return super.equals(t)&&t instanceof H&&I.equalsOrBothNull(this.repeatToken,t.repeatToken)&&I.equalsOrBothNull(this.countToken,t.countToken)&&I.equalsOrBothNull(this.timesToken,t.timesToken)&&I.equalsOrBothNull(this.body,t.body)}createWrapper(t,e,i,n){return new j(this,t,e,i,n)}static createChildren(t,e,i,n){const r=new _;return r.addChildOrError(t,"Missing repeat token"),r.addChildOrError(e,"Missing count token"),r.addChildOrError(i,"Missing times token"),r.addChildOrError(n,"Missing body"),r}}class J extends q{get whileToken(){return void 0===this._whileToken&&this.initialize(),this._whileToken}get operationToken(){return void 0===this._operationToken&&this.initialize(),this._operationToken}get condition(){return void 0===this._condition&&this.initialize(),this._condition}get body(){return void 0===this._body&&this.initialize(),this._body}constructor(t,e,i,n,r){super(t,e,i,n,r),this._whileToken=void 0,this._operationToken=void 0,this._condition=void 0,this._body=void 0}with(t){const e=this.primitive;return new G(void 0===t.whileToken?e.whileToken:t.whileToken?.primitive??null,void 0===t.operationToken?e.operationToken:t.operationToken?.primitive??null,void 0===t.condition?e.condition:t.condition?.primitive??null,void 0===t.body?e.body:t.body?.primitive??null).createWrapper(null,0,1,1)}initialize(){const t=this.primitive;let e=0;this._whileToken=null!==t.whileToken?this.children[e]:null,e+=null!==t.whileToken?1:0,this._operationToken=null!==t.operationToken?this.children[e]:null,e+=null!==t.operationToken?1:0,this._condition=null!==t.condition?this.children[e]:null,e+=null!==t.condition?1:0,this._body=null!==t.body?this.children[e]:null}}class G extends O{constructor(t,e,i,n){super(G.createChildren(t,e,i,n)),this.whileToken=t,this.operationToken=e,this.condition=i,this.body=n}equals(t){return super.equals(t)&&t instanceof G&&I.equalsOrBothNull(this.whileToken,t.whileToken)&&I.equalsOrBothNull(this.operationToken,t.operationToken)&&I.equalsOrBothNull(this.condition,t.condition)&&I.equalsOrBothNull(this.body,t.body)}createWrapper(t,e,i,n){return new J(this,t,e,i,n)}static createChildren(t,e,i,n){const r=new _;return r.addChildOrError(t,"Missing repeat token"),r.addChildOrError(e,"Missing operation token"),r.addChildOrError(i,"Missing condition"),r.addChildOrError(n,"Missing body"),r}}class X{constructor(t){this.text=t}equals(t){return this.constructor===t.constructor&&this.text===t.text}}class Z extends X{constructor(t){super(t.buildText()),this.token=t}}class K extends X{}class $ extends z{get text(){return this.primitive.text}get leadingTrivia(){return this.primitive.leadingTrivia}get trailingTrivia(){return this.primitive.trailingTrivia}constructor(t,e,i,n,r){super(t,e,i,n,r)}getTextRangeWithoutTrivia(){const t=this.primitive;return new N(this.position+t.textPosition,t.text.length)}getLineTextRangeWithoutTrivia(){const t=this.primitive;return new P(this.startLine+t.textStartLine-1,t.textStartLine>1?t.textStartColumn:this.startColumn+t.textStartColumn-1,this.startLine+t.textEndLine-1,t.textEndLine>1?t.textEndColumn:this.startColumn+t.textEndColumn-1)}}class Q extends L{constructor(t,e=[],i=[]){const n=[];let r=0,s=1,o=1;for(const t of e){const e=s,i=o;for(let e=0;e<t.text.length;e++)("\r"!==t.text[e]||e+1<t.text.length&&"\n"===t.text[e+1])&&"\n"!==t.text[e]?o++:(s++,o=1);r+=t.text.length,t instanceof Z&&n.push(new S("Skipped token",new P(e,i,s,o))),t instanceof K&&n.push(new S("Invalid characters",new P(e,i,s,o)))}const a=r,l=s,h=o;for(let e=0;e<t.length;e++)("\r"!==t[e]||e+1<t.length&&"\n"===t[e+1])&&"\n"!==t[e]?o++:(s++,o=1);r+=t.length;const c=s,u=o;for(const t of i){const e=s,i=o;for(let e=0;e<t.text.length;e++)("\r"!==t.text[e]||e+1<t.text.length&&"\n"===t.text[e+1])&&"\n"!==t.text[e]?o++:(s++,o=1);r+=t.text.length,t instanceof Z&&n.push(new S("Skipped token",new P(e,i,s,o))),t instanceof K&&n.push(new S("Invalid characters",new P(e,i,s,o)))}super(r,s,o-1,n),this.text=t,this.leadingTrivia=e,this.trailingTrivia=i,this.textPosition=a,this.textStartLine=l,this.textStartColumn=h,this.textEndLine=c,this.textEndColumn=u}equals(t){return t instanceof Q&&this.text===t.text&&E.equals(this.leadingTrivia,t.leadingTrivia,((t,e)=>t.equals(e)))&&E.equals(this.trailingTrivia,t.trailingTrivia,((t,e)=>t.equals(e)))}pushText(t){for(const e of this.leadingTrivia)t.push(e.text);t.push(this.text);for(const e of this.trailingTrivia)t.push(e.text)}}class Y extends ${constructor(t,e,i,n,r){super(t,e,i,n,r)}}class tt extends Q{equals(t){return super.equals(t)&&t instanceof tt}with(t){return new tt(void 0===t.text?this.text:t.text,void 0===t.leadingTrivia?this.leadingTrivia:t.leadingTrivia,void 0===t.trailingTrivia?this.trailingTrivia:t.trailingTrivia)}createWrapper(t,e,i,n){return new Y(this,t,e,i,n)}}class et{static emit(t){const e=t.symbolTable.getDefined().filter((t=>t instanceof b)).map((t=>{const e=t;return et.throwCompilationHasErrorsIfNull(e.definition.nameToken),[t,new l(e.definition.nameToken.text,[],0)]})),i=new Map(e);for(const n of e){const e=n[0],r=n[1],s=new it(i,t);this.emitProgram(e,s),r.instructions.push(...s.getInstructions()),r.variableCount=s.getVariableCount()}const n=e.map((t=>t[1]));return new a(n)}static emitProgram(t,e){et.throwCompilationHasErrorsIfNull(t.definition.body),this.emitBlock(t.definition.body,e)}static emitBlock(t,e){for(const i of t.statements)if(i instanceof F)this.emitCall(i,e);else if(i instanceof A)this.emitIf(i,e);else if(i instanceof J)this.emitWhile(i,e);else{if(!(i instanceof j))throw new Error;this.emitRepeat(i,e)}}static emitCall(t,e){const i=e.compilation.symbolTable.getByNode(t);if(i instanceof b){const t=e.getProgram(i);e.emit(new d(t))}else e.emit(new u(i.externalProgram.name))}static emitIf(t,e){et.throwCompilationHasErrorsIfNull(t.condition),et.throwCompilationHasErrorsIfNull(t.body),this.emitCall(t.condition,e);const i=e.emitLater();this.emitBlock(t.body,e);const n=null!==t.elseBody?e.emitLater():null;t.operationToken instanceof Y?i(new p(e.nextInstructionIndex)):i(new g(e.nextInstructionIndex)),null!==t.elseBody&&(this.emitBlock(t.elseBody,e),n(new T(e.nextInstructionIndex)))}static emitWhile(t,e){et.throwCompilationHasErrorsIfNull(t.condition),et.throwCompilationHasErrorsIfNull(t.body);const i=e.nextInstructionIndex;this.emitCall(t.condition,e);const n=e.emitLater();this.emitBlock(t.body,e),e.emit(new T(i)),t.operationToken instanceof Y?n(new p(e.nextInstructionIndex)):n(new g(e.nextInstructionIndex))}static emitRepeat(t,e){et.throwCompilationHasErrorsIfNull(t.countToken),et.throwCompilationHasErrorsIfNull(t.body);const i=e.createVariable();e.emit(new f(0)),e.emit(new v(i));const n=e.nextInstructionIndex,r=parseInt(t.countToken.text);e.emit(new f(r)),e.emit(new w(i)),e.emit(new m);const s=e.emitLater();this.emitBlock(t.body,e),e.emit(new f(1)),e.emit(new w(i)),e.emit(new c),e.emit(new v(i)),e.emit(new T(n)),s(new p(e.nextInstructionIndex))}static throwCompilationHasErrorsIfNull(t){if(null===t)throw new Error("Can not emit a compilation that contains errors.")}}class it{get nextInstructionIndex(){return this.instructions.length}createVariable(){return this.variableCount++}getProgram(t){const e=this.programSymbolToProgramMap.get(t);if(void 0===e)throw new Error("Program for this symbol was not found.");return e}emit(t){this.instructions.push(t)}emitLater(){const t=this.instructions.length;return this.instructions.push(null),this.laterEmitsCount++,e=>{if(null!==this.instructions[t])throw new Error("This emitLater function was already used.");this.laterEmitsCount--,this.instructions[t]=e}}getInstructions(){if(0!==this.laterEmitsCount)throw new Error("Can not get instructons before all later emits are done.");return this.instructions}getVariableCount(){return this.variableCount}constructor(t,e){this.programSymbolToProgramMap=t,this.compilation=e,this.variableCount=0,this.instructions=[],this.laterEmitsCount=0}}class nt{constructor(t,e,i){this.message=t,this.compilationUnit=e,this.textRange=i}}!function(t){t[t.program=0]="program",t[t.externalProgram=1]="externalProgram"}(e||(e={}));class rt{constructor(t,e,i,n){this.text=t,this.title=e,this.description=i,this.type=n}}class st{constructor(t){this.compilation=t}getCompletionItemsAt(t,e,i){return this.compilation.symbolTable.getDefined().filter((t=>!(t instanceof b&&null===t.definition.nameToken))).map((t=>this.createCompletionItem(t)))}createCompletionItem(i){if(i instanceof y)return new rt(i.externalProgram.name,i.externalProgram.name,i.externalProgram.returnType===t.number?"number":"unit",e.externalProgram);if(i instanceof b)return new rt(i.definition.nameToken.text,i.definition.nameToken.text,"unit",e.program);throw new Error("Not supported.")}}class ot{static check(t){const e=[];for(const i of t.compilationUnits)this.checkNode(i,e,i,t);return e}static checkNode(t,e,i,n){this.addSyntaxErrors(t,e,i),t instanceof F&&this.checkCall(t,e,i,n),t instanceof A&&this.checkIf(t,e,i,n),t instanceof J&&this.checkWhile(t,e,i,n),t instanceof W&&this.checkProgram(t,e,i,n);for(const r of t.children)r instanceof q?this.checkNode(r,e,i,n):this.addSyntaxErrors(r,e,i)}static addSyntaxErrors(t,e,i){for(const n of t.primitive.syntaxErrors)e.push(new nt(n.message,i,new P(t.startLine+n.textRange.startLine-1,n.textRange.startLine>1?n.textRange.startColumn:t.startColumn+n.textRange.startColumn-1,t.startLine+n.textRange.endLine-1,n.textRange.endLine>1?n.textRange.endColumn:t.startColumn+n.textRange.endColumn-1)))}static checkIf(e,i,n,r){if(null===e.condition)return;const s=r.symbolTable.getByNode(e.condition);s instanceof b&&i.push(new nt("Invalid condition symbol type",n,e.condition.getLineTextRangeWithoutTrivia())),s instanceof y&&s.externalProgram.returnType!==t.number&&i.push(new nt("Invalid condition data type",n,e.condition.getLineTextRangeWithoutTrivia()))}static checkWhile(e,i,n,r){if(null===e.condition)return;const s=r.symbolTable.getByNode(e.condition);s instanceof b&&i.push(new nt("Invalid condition symbol type",n,e.condition.getLineTextRangeWithoutTrivia())),s instanceof y&&s.externalProgram.returnType!==t.number&&i.push(new nt("Invalid condition data type",n,e.condition.getLineTextRangeWithoutTrivia()))}static checkCall(t,e,i,n){const r=n.symbolTable.getByNode(t);null===r&&e.push(new nt("Unresolved symbol",i,t.getLineTextRangeWithoutTrivia())),r instanceof C&&e.push(new nt("Ambiguous symbol",i,t.getLineTextRangeWithoutTrivia()))}static checkProgram(t,e,i,n){null!==t.nameToken&&n.symbolTable.getByName(t.nameToken.text)instanceof C&&e.push(new nt("Program declared twice",i,t.nameToken.getLineTextRangeWithoutTrivia()))}}class at extends ${constructor(t,e,i,n,r){super(t,e,i,n,r)}}class lt extends Q{equals(t){return super.equals(t)&&t instanceof lt}with(t){return new lt(void 0===t.text?this.text:t.text,void 0===t.leadingTrivia?this.leadingTrivia:t.leadingTrivia,void 0===t.trailingTrivia?this.trailingTrivia:t.trailingTrivia)}createWrapper(t,e,i,n){return new at(this,t,e,i,n)}}class ht{get current(){return this.currentIndex<this.text.length?this.text[this.currentIndex]:null}get next(){return this.currentIndex+1<this.text.length?this.text[this.currentIndex+1]:null}constructor(t){this.text=t,this.currentIndex=0,this.collectStartIndex=0}goNext(){if(this.currentIndex>=this.text.length)throw new Error("The context has already reached the end.");this.currentIndex++}collect(){const t=this.text.slice(this.collectStartIndex,this.currentIndex);return this.collectStartIndex=this.currentIndex,t}}class ct{get current(){return this._current}constructor(t){if(0===t.length||!(t[t.length-1]instanceof lt))throw new Error("Last token must be an EndOfFilePrimitiveToken.");this.tokens=t,this.skippedTokenTrivia=[],this.currentIndex=0,this._current=this.createCurrent()}goNext(){this.throwIfLastToken(),this.skippedTokenTrivia.length=0,this.currentIndex++,this._current=this.createCurrent()}skip(){this.throwIfLastToken();const t=new Z(this.tokens[this.currentIndex]);this.skippedTokenTrivia.push(t),this.currentIndex++,this._current=this.createCurrent()}createCurrent(){const t=this.tokens[this.currentIndex];return 0===this.skippedTokenTrivia.length?t:t.with({leadingTrivia:[...this.skippedTokenTrivia,...t.leadingTrivia]})}throwIfLastToken(){if(this.currentIndex>=this.tokens.length-1)throw new Error("The context has already reached the end.")}}class ut extends ${constructor(t,e,i,n,r){super(t,e,i,n,r)}}class dt extends Q{equals(t){return super.equals(t)&&t instanceof dt}with(t){return new dt(void 0===t.text?this.text:t.text,void 0===t.leadingTrivia?this.leadingTrivia:t.leadingTrivia,void 0===t.trailingTrivia?this.trailingTrivia:t.trailingTrivia)}createWrapper(t,e,i,n){return new ut(this,t,e,i,n)}}class mt extends ${constructor(t,e,i,n,r){super(t,e,i,n,r)}}class pt extends Q{equals(t){return super.equals(t)&&t instanceof pt}with(t){return new pt(void 0===t.text?this.text:t.text,void 0===t.leadingTrivia?this.leadingTrivia:t.leadingTrivia,void 0===t.trailingTrivia?this.trailingTrivia:t.trailingTrivia)}createWrapper(t,e,i,n){return new mt(this,t,e,i,n)}}class gt extends ${constructor(t,e,i,n,r){super(t,e,i,n,r)}}class Tt extends Q{equals(t){return super.equals(t)&&t instanceof Tt}with(t){return new Tt(void 0===t.text?this.text:t.text,void 0===t.leadingTrivia?this.leadingTrivia:t.leadingTrivia,void 0===t.trailingTrivia?this.trailingTrivia:t.trailingTrivia)}createWrapper(t,e,i,n){return new gt(this,t,e,i,n)}}class wt extends ${constructor(t,e,i,n,r){super(t,e,i,n,r)}}class kt extends Q{equals(t){return super.equals(t)&&t instanceof kt}with(t){return new kt(void 0===t.text?this.text:t.text,void 0===t.leadingTrivia?this.leadingTrivia:t.leadingTrivia,void 0===t.trailingTrivia?this.trailingTrivia:t.trailingTrivia)}createWrapper(t,e,i,n){return new wt(this,t,e,i,n)}}class ft extends ${constructor(t,e,i,n,r){super(t,e,i,n,r)}}class vt extends Q{equals(t){return super.equals(t)&&t instanceof vt}with(t){return new vt(void 0===t.text?this.text:t.text,void 0===t.leadingTrivia?this.leadingTrivia:t.leadingTrivia,void 0===t.trailingTrivia?this.trailingTrivia:t.trailingTrivia)}createWrapper(t,e,i,n){return new ft(this,t,e,i,n)}}class xt extends ${constructor(t,e,i,n,r){super(t,e,i,n,r)}}class Ct extends Q{equals(t){return super.equals(t)&&t instanceof Ct}with(t){return new Ct(void 0===t.text?this.text:t.text,void 0===t.leadingTrivia?this.leadingTrivia:t.leadingTrivia,void 0===t.trailingTrivia?this.trailingTrivia:t.trailingTrivia)}createWrapper(t,e,i,n){return new xt(this,t,e,i,n)}}class yt extends ${constructor(t,e,i,n,r){super(t,e,i,n,r)}}class bt extends Q{equals(t){return super.equals(t)&&t instanceof bt}with(t){return new bt(void 0===t.text?this.text:t.text,void 0===t.leadingTrivia?this.leadingTrivia:t.leadingTrivia,void 0===t.trailingTrivia?this.trailingTrivia:t.trailingTrivia)}createWrapper(t,e,i,n){return new yt(this,t,e,i,n)}}class It extends ${constructor(t,e,i,n,r){super(t,e,i,n,r)}}class St extends Q{equals(t){return super.equals(t)&&t instanceof St}with(t){return new St(void 0===t.text?this.text:t.text,void 0===t.leadingTrivia?this.leadingTrivia:t.leadingTrivia,void 0===t.trailingTrivia?this.trailingTrivia:t.trailingTrivia)}createWrapper(t,e,i,n){return new It(this,t,e,i,n)}}class Pt extends ${constructor(t,e,i,n,r){super(t,e,i,n,r)}}class _t extends Q{equals(t){return super.equals(t)&&t instanceof _t}with(t){return new _t(void 0===t.text?this.text:t.text,void 0===t.leadingTrivia?this.leadingTrivia:t.leadingTrivia,void 0===t.trailingTrivia?this.trailingTrivia:t.trailingTrivia)}createWrapper(t,e,i,n){return new Pt(this,t,e,i,n)}}class Et extends ${constructor(t,e,i,n,r){super(t,e,i,n,r)}}class Nt extends Q{equals(t){return super.equals(t)&&t instanceof Nt}with(t){return new Nt(void 0===t.text?this.text:t.text,void 0===t.leadingTrivia?this.leadingTrivia:t.leadingTrivia,void 0===t.trailingTrivia?this.trailingTrivia:t.trailingTrivia)}createWrapper(t,e,i,n){return new Et(this,t,e,i,n)}}class zt extends X{}class Lt extends X{}class qt extends X{}class Ot extends X{}class Ft{static tokenize(t){const e=this.tokenizeTrivia(t,!1);if(null===t.current)return new lt("",e,[]);if(this.isNumberCharacter(t.current))return this.tokenizeNumber(t,e);if(this.isIdentifierCharacter(t.current))return this.tokenizeIdentifier(t,e);throw new Error("Assertion error: This should not happen, other types of characters should be handled with leading trivia.")}static tokenizeIdentifier(t,e){for(;null!==t.current&&this.isIdentifierCharacter(t.current);)t.goNext();const i=t.collect();return"program"===i?new bt(i,e,this.tokenizeTrivia(t,!0)):"if"===i?new kt(i,e,this.tokenizeTrivia(t,!0)):"else"===i?new dt(i,e,this.tokenizeTrivia(t,!0)):"while"===i?new Nt(i,e,this.tokenizeTrivia(t,!0)):"repeat"===i?new St(i,e,this.tokenizeTrivia(t,!0)):"times"===i?new _t(i,e,this.tokenizeTrivia(t,!0)):"is"===i?new tt(i,e,this.tokenizeTrivia(t,!0)):"not"===i?new vt(i,e,this.tokenizeTrivia(t,!0)):"end"===i?new pt(i,e,this.tokenizeTrivia(t,!0)):new Tt(i,e,this.tokenizeTrivia(t,!0))}static tokenizeNumber(t,e){for(;null!==t.current&&this.isNumberCharacter(t.current);)t.goNext();const i=t.collect();return new Ct(i,e,this.tokenizeTrivia(t,!0))}static tokenizeTrivia(t,e){const i=[];for(;null!==t.current;){if(this.isWhitespaceCharacter(t.current))i.push(this.tokenizeWhitespaceTrivia(t));else if("\r"===t.current||"\n"===t.current)i.push(this.tokenizeEndOfLineTrivia(t));else if("/"===t.current&&null!==t.next&&"/"===t.next)i.push(this.tokenizeSingleLineCommentTrivia(t));else if("/"===t.current&&null!==t.next&&"*"===t.next)i.push(this.tokenizeMultiLineCommentTrivia(t));else{if(this.isNumberCharacter(t.current)||this.isIdentifierCharacter(t.current))break;i.push(this.tokenizeInvalidCharactersTrivia(t))}if(e&&this.containsEndOfLine(i[i.length-1]))break}return i}static tokenizeWhitespaceTrivia(t){for(;null!==t.current&&Ft.isWhitespaceCharacter(t.current);)t.goNext();const e=t.collect();return new Ot(e)}static tokenizeEndOfLineTrivia(t){"\r"===t.current&&null!==t.next&&"\n"==t.next&&t.goNext(),t.goNext();const e=t.collect();return new zt(e)}static tokenizeSingleLineCommentTrivia(t){for(t.goNext(),t.goNext();null!==t.current&&"\n"!==t.current&&"\r"!==t.current;)t.goNext();const e=t.collect();return new qt(e)}static tokenizeMultiLineCommentTrivia(t){for(t.goNext(),t.goNext();null!==t.current&&("*"!==t.current||null===t.next||"/"!==t.next);)t.goNext();null!==t.next&&(t.goNext(),t.goNext());const e=t.collect();return new Lt(e)}static tokenizeInvalidCharactersTrivia(t){for(;null!==t.current&&!this.isIdentifierCharacter(t.current)&&!this.isNumberCharacter(t.current)&&!this.isWhitespaceCharacter(t.current)&&"\n"!==t.current&&"\r"!==t.current&&("/"!==t.current||null===t.next||"/"!==t.next&&"*"!==t.next);)t.goNext();const e=t.collect();return new K(e)}static containsEndOfLine(t){for(const e of t.text)if("\r"===e||"\n"===e)return!0;return!1}static isNumberCharacter(t){return t>="0"&&t<="9"}static isIdentifierCharacter(t){return t>="a"&&t<="z"||t>="A"&&t<="Z"||t>="0"&&t<="9"}static isWhitespaceCharacter(t){return" "===t}}class Rt extends q{get statements(){return void 0===this._statements&&this.initialize(),this._statements}get endToken(){return void 0===this._endToken&&this.initialize(),this._endToken}constructor(t,e,i,n,r){super(t,e,i,n,r),this._statements=void 0,this._endToken=void 0}with(t){const e=this.primitive;return new Wt(void 0===t.statements?e.statements:t.statements.map((t=>t.primitive)),void 0===t.endToken?e.endToken:t.endToken?.primitive??null).createWrapper(null,0,1,1)}initialize(){const t=this.primitive;let e=0;this._statements=this.children.slice(0,t.statements.length),e+=t.statements.length,this._endToken=null!==t.endToken?this.children[e]:null}}class Wt extends O{constructor(t,e){super(Wt.createChildren(t,e)),this.statements=t,this.endToken=e}equals(t){return super.equals(t)&&t instanceof Wt&&E.equals(this.statements,t.statements,((t,e)=>t.equals(e)))&&I.equalsOrBothNull(this.endToken,t.endToken)}createWrapper(t,e,i,n){return new Rt(this,t,e,i,n)}static createChildren(t,e){const i=new _;for(const e of t)i.addChild(e);return i.addChildOrError(e,"Missing end token"),i}}class Bt extends q{get programs(){return void 0===this._programs&&this.initialize(),this._programs}get endOfFileToken(){return void 0===this._endOfFileToken&&this.initialize(),this._endOfFileToken}get filePath(){return this.primitive.filePath}constructor(t,e,i,n,r){super(t,e,i,n,r),this._programs=void 0,this._endOfFileToken=void 0}with(t){const e=this.primitive;return new Mt(void 0===t.programs?e.programs:t.programs.map((t=>t.primitive)),void 0===t.endOfFileToken?e.endOfFileToken:t.endOfFileToken.primitive,void 0===t.filePath?e.filePath:t.filePath).createWrapper(null,0,1,1)}initialize(){const t=this.primitive;let e=0;this._programs=this.children.slice(0,t.programs.length),e+=t.programs.length,this._endOfFileToken=this.children[e]}}class Mt extends O{constructor(t,e,i){super(Mt.createChildren(t,e)),this.programs=t,this.endOfFileToken=e,this.filePath=i}equals(t){return super.equals(t)&&t instanceof Mt&&E.equals(this.programs,t.programs,((t,e)=>t.equals(e)))&&I.equalsOrBothNull(this.endOfFileToken,t.endOfFileToken)&&this.filePath===t.filePath}createWrapper(t,e,i,n){return new Bt(this,t,e,i,n)}static createChildren(t,e){const i=new _;for(const e of t)i.addChild(e);return i.addChildOrError(e,"Missing end of file token"),i}}class Ut{static parseCompilationUnit(t,e){let i=[],n=null;for(;!(t.current instanceof lt);)if(t.current instanceof bt){const e=this.parseProgram(t);i.push(e)}else t.skip();return n=t.current,new Mt(i,n,e)}static parseProgram(t){let e=null,i=null,n=null;return e=t.current,t.goNext(),!(t.current instanceof lt)&&t.current instanceof Tt&&(i=t.current,t.goNext()),t.current instanceof lt||(n=this.parseBlock(t)),new B(e,i,n)}static parseBlock(t){let e=[],i=null;for(;!(t.current instanceof lt||t.current instanceof pt);){let i=null;t.current instanceof kt?i=this.parseIf(t):t.current instanceof Nt?i=this.parseWhile(t):t.current instanceof St?i=this.parseRepeat(t):t.current instanceof Tt?i=this.parseCall(t):t.skip(),null!==i&&e.push(i)}return!(t.current instanceof lt)&&t.current instanceof pt&&(i=t.current,t.goNext()),new Wt(e,i)}static parseIf(t){let e=null,i=null,n=null,r=null,s=null,o=null;return e=t.current,t.goNext(),t.current instanceof lt||!(t.current instanceof tt||t.current instanceof vt)||(i=t.current,t.goNext()),!(t.current instanceof lt)&&t.current instanceof Tt&&(n=this.parseCall(t)),t.current instanceof lt||(r=this.parseBlock(t)),!(t.current instanceof lt)&&t.current instanceof dt&&(s=t.current,t.goNext(),t.current instanceof lt||(o=this.parseBlock(t))),new V(e,i,n,r,s,o)}static parseWhile(t){let e=null,i=null,n=null,r=null;return e=t.current,t.goNext(),t.current instanceof lt||!(t.current instanceof tt||t.current instanceof vt)||(i=t.current,t.goNext()),!(t.current instanceof lt)&&t.current instanceof Tt&&(n=this.parseCall(t)),t.current instanceof lt||(r=this.parseBlock(t)),new G(e,i,n,r)}static parseRepeat(t){let e=null,i=null,n=null,r=null;return e=t.current,t.goNext(),!(t.current instanceof lt)&&t.current instanceof Ct&&(i=t.current,t.goNext()),!(t.current instanceof lt)&&t.current instanceof _t&&(n=t.current,t.goNext()),t.current instanceof lt||(r=this.parseBlock(t)),new H(e,i,n,r)}static parseCall(t){let e=null;return e=t.current,t.goNext(),new R(e)}}class Dt{static parse(t,e){const i=new ht(t),n=[];for(;;){const t=Ft.tokenize(i);if(n.push(t),t instanceof lt)break}const r=new ct(n);return Ut.parseCompilationUnit(r,e).createWrapper(null,0,1,1)}}class At{get currentInstruction(){return this.program.instructions[this.currentInstructionIndex]}constructor(t){this.evaluationStack=[],this.currentInstructionIndex=0,this.program=t,this.variables=new Array(t.variableCount).fill(0)}}class Vt{constructor(t){this.message=t}}class jt{constructor(t,e){this.name=t,this.handler=e}}class Ht{constructor(){this.stopRequested=new o,this._isStopRequested=!1}get isStopRequested(){return this._isStopRequested}stop(){if(this.isStopRequested)throw new Error("Stop can be requested at most once.");this._isStopRequested=!0,this.stopRequested.emit()}}class Jt{constructor(t){this.exception=t}}class Gt{}class Xt{}class Zt{constructor(){this.maxCallStackSize=null,this.callStack=[],this.externalProgramMap=new Map}get currentStackFrame(){return 0===this.callStack.length?null:this.callStack[this.callStack.length-1]}addExternalProgram(t){if(this.externalProgramMap.has(t.name))throw new Error;this.externalProgramMap.set(t.name,t)}removeExternalProgram(t){this.externalProgramMap.get(t.name)===t&&this.externalProgramMap.delete(t.name)}async interpretAll(t){return this.interpretWhile((()=>!0),t)}async interpretSingle(t){let e=0;return this.interpretWhile((()=>1!=e++),t)}async interpretWhile(t,e){for(;null!==this.currentStackFrame&&t();){if(e.isStopRequested)return new Gt;let t=this.interpretCurrent(e);if(t instanceof Promise&&(t=await t),t instanceof Vt)return this.callStack.length=0,new Jt(t)}return new Xt}interpretCurrent(t){for(;null!==this.currentStackFrame&&this.currentStackFrame.currentInstructionIndex>=this.currentStackFrame.program.instructions.length;)this.callStack.pop();if(null!==this.currentStackFrame){const e=this.currentStackFrame.currentInstruction;return this.currentStackFrame.currentInstructionIndex++,this.interpret(e,t)}}interpret(t,e){if(t instanceof c)this.interpretAdd(t);else{if(t instanceof u)return this.interpretCallExternal(t,e);if(t instanceof d)return this.interpretCall(t);if(t instanceof m)this.interpretCompareGreater(t);else if(t instanceof p)this.interpretJumpIfFalse(t);else if(t instanceof g)this.interpretJumpIfTrue(t);else if(t instanceof T)this.interpretJump(t);else if(t instanceof w)this.interpretLoad(t);else if(t instanceof k)this.interpretPop(t);else if(t instanceof f)this.interpretPush(t);else{if(!(t instanceof v))throw new Error("Unknown instruction.");this.interpretStore(t)}}}interpretAdd(t){if(null===this.currentStackFrame)throw new Error;if(this.currentStackFrame.evaluationStack.length<2)throw new Error;const e=this.currentStackFrame.evaluationStack.pop()+this.currentStackFrame.evaluationStack.pop();this.currentStackFrame.evaluationStack.push(e)}async interpretCallExternal(t,e){const i=this.externalProgramMap.get(t.name);if(void 0===i)throw new Error;let n=i.handler(this,e);if(n instanceof Promise&&(n=await n),n instanceof Vt)return n;"number"==typeof n&&null!==this.currentStackFrame&&this.currentStackFrame.evaluationStack.push(n)}interpretCall(t){const e=new At(t.program);if(this.callStack.push(e),null!==this.maxCallStackSize&&this.callStack.length>this.maxCallStackSize)return new Vt("Stack overflow.")}interpretCompareGreater(t){if(null===this.currentStackFrame)throw new Error;if(this.currentStackFrame.evaluationStack.length<2)throw new Error;const e=this.currentStackFrame.evaluationStack.pop()<this.currentStackFrame.evaluationStack.pop()?1:0;this.currentStackFrame.evaluationStack.push(e)}interpretJumpIfFalse(t){if(null===this.currentStackFrame)throw new Error;if(0===this.currentStackFrame.evaluationStack.length)throw new Error;0===this.currentStackFrame.evaluationStack.pop()&&(this.currentStackFrame.currentInstructionIndex=t.instructionIndex)}interpretJumpIfTrue(t){if(null===this.currentStackFrame)throw new Error;if(0===this.currentStackFrame.evaluationStack.length)throw new Error;1===this.currentStackFrame.evaluationStack.pop()&&(this.currentStackFrame.currentInstructionIndex=t.instructionIndex)}interpretJump(t){if(null===this.currentStackFrame)throw new Error;this.currentStackFrame.currentInstructionIndex=t.instructionIndex}interpretLoad(t){if(null===this.currentStackFrame)throw new Error;if(this.currentStackFrame.variables.length<=t.localIndex)throw new Error;const e=this.currentStackFrame.variables[t.localIndex];this.currentStackFrame.evaluationStack.push(e)}interpretPop(t){if(null===this.currentStackFrame)throw new Error;if(0===this.currentStackFrame.evaluationStack.length)throw new Error;this.currentStackFrame.evaluationStack.pop()}interpretPush(t){if(null===this.currentStackFrame)throw new Error;this.currentStackFrame.evaluationStack.push(t.value)}interpretStore(t){if(null===this.currentStackFrame)throw new Error;if(0===this.currentStackFrame.evaluationStack.length)throw new Error;if(this.currentStackFrame.variables.length<=t.localIndex)throw new Error;const e=this.currentStackFrame.evaluationStack.pop();this.currentStackFrame.variables[t.localIndex]=e}}class Kt{constructor(t,e,i,n){this.x=t,this.y=e,this.width=i,this.height=n}}class $t{static{this.ZERO=new $t(0,0)}constructor(t,e){this.x=t,this.y=e}}class Qt{}class Yt extends Qt{get name(){return this.compilationUnit.filePath}constructor(t){super(),this.compilationUnit=t}withName(t){const e=this.compilationUnit.with({filePath:t});return new Yt(e)}withCompilationUnit(t){return new Yt(t)}}!function(t){t[t.up=0]="up",t[t.right=1]="right",t[t.down=2]="down",t[t.left=3]="left"}(i||(i={})),function(t){t[t.land=0]="land",t[t.wall=1]="wall"}(n||(n={}));class te{static get MAX_SIGN_COUNT(){return ee.MAX_SIGN_COUNT}get width(){return this.mutableTown.width}get height(){return this.mutableTown.height}get karelPosition(){return this.mutableTown.karelPosition}get karelDirection(){return this.mutableTown.karelDirection}get homePosition(){return this.mutableTown.homePosition}constructor(t){this.mutableTown=t}static create(t,e,i,n,r,s,o){const a=ee.create(t,e,i,n,r,s,o);return new te(a)}static createEmpty(t,e){const i=ee.createEmpty(t,e);return new te(i)}getTileAt(t,e){return this.mutableTown.getTileAt(t,e)}getSignCountAt(t,e){return this.mutableTown.getSignCountAt(t,e)}getTiles(){return this.mutableTown.getTiles()}getSignCounts(){return this.mutableTown.getSignCounts()}toMutable(){return this.mutableTown.clone()}}class ee{static{this.MAX_SIGN_COUNT=8}get width(){return this._width}get height(){return this._height}get karelPosition(){return this._karelPosition}set karelPosition(t){ee.throwIfInvalidCoordinates(t.x,t.y,this.width,this.height),this._karelPosition=t}get homePosition(){return this._homePosition}set homePosition(t){ee.throwIfInvalidCoordinates(t.x,t.y,this.width,this.height),this._homePosition=t}constructor(t,e,i,n,r,s,o){this._width=t,this._height=e,this._karelPosition=i,this.karelDirection=n,this._homePosition=r,this.tiles=s,this.signCounts=o}static create(t,e,i,n,r,s,o){ee.throwIfInvalidSize(t),ee.throwIfInvalidSize(e),ee.throwIfInvalidCoordinates(i.x,i.y,t,e),ee.throwIfInvalidCoordinates(r.x,r.y,t,e);for(const t of o)ee.throwIfInvalidSignCount(t);const a=t*e;if(s.length!==a)throw new Error("Length of tiles is not equal to width * height.");if(o.length!==a)throw new Error("Length of sign counts is not equal to width * height.");return new ee(t,e,i,n,r,[...s],[...o])}static createEmpty(t,e){ee.throwIfInvalidSize(t),ee.throwIfInvalidSize(e);const r=t*e,s=new Array(r),o=new Array(r);return s.fill(0),o.fill(n.land),new ee(t,e,$t.ZERO,i.right,$t.ZERO,s,o)}clone(){return new ee(this.width,this.height,this.karelPosition,this.karelDirection,this.homePosition,[...this.tiles],[...this.signCounts])}resize(t,e){ee.throwIfInvalidSize(t),ee.throwIfInvalidSize(e);const i=t*e,r=new Array(i),s=new Array(i);for(let i=0;i<e;i++)for(let e=0;e<t;e++)e<this.width&&i<this.height?(r[i*t+e]=this.tiles[i*this.width+e],s[i*t+e]=this.signCounts[i*this.width+e]):(r[i*t+e]=n.land,s[i*t+e]=0);this._width=t,this._height=e,this._karelPosition=new $t(Math.min(t-1,this.karelPosition.x),Math.min(e-1,this.karelPosition.y)),this._homePosition=new $t(Math.min(t-1,this.homePosition.x),Math.min(e-1,this.homePosition.y)),this.tiles=r,this.signCounts=s}getTileAt(t,e){return ee.throwIfInvalidCoordinates(t,e,this.width,this.height),this.tiles[this.convert2DTo1D(t,e)]}setTileAt(t,e,i){ee.throwIfInvalidCoordinates(t,e,this.width,this.height),this.tiles[this.convert2DTo1D(t,e)]=i}getSignCountAt(t,e){return ee.throwIfInvalidCoordinates(t,e,this.width,this.height),this.signCounts[this.convert2DTo1D(t,e)]}setSignCountAt(t,e,i){ee.throwIfInvalidCoordinates(t,e,this.width,this.height),ee.throwIfInvalidSignCount(i),this.signCounts[this.convert2DTo1D(t,e)]=i}getTiles(){return this.tiles}getSignCounts(){return this.signCounts}toImmutable(){return te.create(this.width,this.height,this.karelPosition,this.karelDirection,this.homePosition,this.tiles,this.signCounts)}convert2DTo1D(t,e){return e*this.width+t}static throwIfInvalidSignCount(t){if(t<0||t>ee.MAX_SIGN_COUNT)throw new Error(`Sign count must be greater than or equal to 0 and less than ${ee.MAX_SIGN_COUNT}.`)}static throwIfInvalidCoordinates(t,e,i,n){if(t<0||t>=i||e<0||e>=n)throw new Error("Coordinates are outside of the town.")}static throwIfInvalidSize(t){if(t<=0)throw new Error("Size must be a positive number.")}}class ie{constructor(t,e,i,n,r){this.name=t,this.files=e,this.externalPrograms=i,this.settings=n,this.compilation=r}static create(t,e,i,n){const r=e.filter((t=>t instanceof Yt)).map((t=>t.compilationUnit)),s=new U(r,i);return new ie(t,e,i,n,s)}withName(t){return new ie(t,this.files,this.externalPrograms,this.settings,this.compilation)}addFile(t){const e=[...this.files,t],i=t instanceof Yt?this.compilation.addCompilationUnit(t.compilationUnit):this.compilation;return new ie(this.name,e,this.externalPrograms,this.settings,i)}removeFile(t){const e=this.files.indexOf(t);if(-1===e)return this;const i=[...this.files];i.splice(e,1);const n=t instanceof Yt?this.compilation.removeCompilationUnit(t.compilationUnit):this.compilation;return new ie(this.name,i,this.externalPrograms,this.settings,n)}replaceFile(t,e){const i=this.files.indexOf(t);if(-1===i)return this;const n=[...this.files];let r;return n[i]=e,r=t instanceof Yt&&e instanceof Yt?this.compilation.replaceCompilationUnit(t.compilationUnit,e.compilationUnit):t instanceof Yt?this.compilation.removeCompilationUnit(t.compilationUnit):e instanceof Yt?this.compilation.addCompilationUnit(e.compilationUnit):this.compilation,new ie(this.name,n,this.externalPrograms,this.settings,r)}withExternalPrograms(t){const e=this.compilation.withExternalPrograms(t);return new ie(this.name,this.files,this.externalPrograms,this.settings,e)}withSettings(t){return new ie(this.name,this.files,this.externalPrograms,t,this.compilation)}}class ne{constructor(t,e,i){this.entryPoint=t,this.karelSpeed=e,this.maxRecursionDepth=i}withEntryPoint(t){return new ne(t,this.karelSpeed,this.maxRecursionDepth)}withKarelSpeed(t){return new ne(this.entryPoint,t,this.maxRecursionDepth)}withMaxRecursionDepth(t){return new ne(this.entryPoint,this.karelSpeed,t)}}class re extends Qt{constructor(t,e){super(),this.name=t,this.town=e}withName(t){return new re(t,this.town)}withTown(t){return new re(this.name,t)}}class se{static deserialize(t,e){const i=JSON.parse(t);return this.deserializeProject(i,e)}static deserializeProject(t,e){return ie.create(t.name,t.files.map((t=>this.deserializeFile(t))),e,this.deserializeSettings(t.settings))}static deserializeSettings(t){return new ne(t.entryPoint,t.karelSpeed,t.maxRecursionDepth)}static deserializeFile(t){if("code"===t.type)return this.deserializeCodeFile(t);if("town"===t.type)return this.deserializeTownFile(t);throw new Error("Not supported.")}static deserializeCodeFile(t){const e=Dt.parse(t.code,t.name);return new Yt(e)}static deserializeTownFile(t){const e=this.deserializeTown(t.town);return new re(t.name,e)}static deserializeTown(t){return te.create(t.width,t.height,new $t(t.karelPosition.x,t.karelPosition.y),t.karelDirection,new $t(t.homePosition.x,t.homePosition.y),t.tiles,t.signCounts)}}class oe{static serialize(t){const e=this.serializeProject(t);return JSON.stringify(e)}static serializeProject(t){return{name:t.name,settings:this.serializeSettings(t.settings),files:t.files.map((t=>this.serializeFile(t)))}}static serializeSettings(t){return{entryPoint:t.entryPoint,karelSpeed:t.karelSpeed,maxRecursionDepth:t.maxRecursionDepth}}static serializeFile(t){if(t instanceof Yt)return this.serializeCodeFile(t);if(t instanceof re)return this.serializeTownFile(t);throw new Error("Not supported.")}static serializeCodeFile(t){return{type:"code",name:t.name,code:t.compilationUnit.buildText()}}static serializeTownFile(t){return{type:"town",name:t.name,town:this.serializeTown(t.town)}}static serializeTown(t){return{width:t.width,height:t.height,karelPosition:{x:t.karelPosition.x,y:t.karelPosition.y},karelDirection:t.karelDirection,homePosition:{x:t.homePosition.x,y:t.homePosition.y},tiles:t.getTiles(),signCounts:t.getSignCounts()}}}class ae{static{this.UP_VECTOR=new $t(0,-1)}static{this.RIGHT_VECTOR=new $t(1,0)}static{this.DOWN_VECTOR=new $t(0,1)}static{this.LEFT_VECTOR=new $t(-1,0)}static toVector(t){if(t===i.up)return this.UP_VECTOR;if(t===i.right)return this.RIGHT_VECTOR;if(t===i.down)return this.DOWN_VECTOR;if(t===i.left)return this.LEFT_VECTOR;throw new Error("Unknown direction.")}static fromVector(t,e){if(0===t&&-1===e)return i.up;if(1===t&&0===e)return i.right;if(0===t&&1===e)return i.down;if(-1===t&&0===e)return i.left;throw new Error("Unknown direction.")}}async function le(t,e,i){await xe(e,i);const n=fe(t);if(!ve(t,n.x,n.y))return new Vt("Wall in a way.");t.karelPosition=n}async function he(t,e,i){await xe(e,i);let{x:n,y:r}=ae.toVector(t.karelDirection);[n,r]=[r,-n],t.karelDirection=ae.fromVector(n,r)}async function ce(t,e,i){await xe(e,i);const n=t.getSignCountAt(t.karelPosition.x,t.karelPosition.y);if(0===n)return new Vt("No sign to pick.");t.setSignCountAt(t.karelPosition.x,t.karelPosition.y,n-1)}async function ue(t,e,i){await xe(e,i);const n=t.getSignCountAt(t.karelPosition.x,t.karelPosition.y);t.setSignCountAt(t.karelPosition.x,t.karelPosition.y,n+1)}function de(t){const e=fe(t);return!ve(t,e.x,e.y)}function me(t){return t.getSignCountAt(t.karelPosition.x,t.karelPosition.y)>0}function pe(t){return t.karelDirection===i.up}function ge(t){return t.karelDirection===i.down}function Te(t){return t.karelDirection===i.left}function we(t){return t.karelDirection===i.right}function ke(t){return t.karelPosition.x===t.homePosition.x&&t.karelPosition.y===t.homePosition.y}function fe(t){const e=ae.toVector(t.karelDirection);return new $t(t.karelPosition.x+e.x,t.karelPosition.y+e.y)}function ve(t,e,i){return!(e<0||i<0||e>=t.width||i>=t.height)&&t.getTileAt(e,i)===n.land}function xe(t,e){return new Promise((i=>{if(e.isStopRequested)return void i();let n=-1;const r=()=>{e.stopRequested.removeListener(r),-1!==n&&clearTimeout(n),i()};e.stopRequested.addListener(r),n=window.setTimeout((()=>{e.stopRequested.removeListener(r),i()}),t)}))}class Ce{static getProgramReferences(){return[new D("step",t.unit),new D("turnLeft",t.unit),new D("pick",t.unit),new D("put",t.unit),new D("wall",t.number),new D("sign",t.number),new D("north",t.number),new D("south",t.number),new D("east",t.number),new D("west",t.number),new D("home",t.number)]}static getPrograms(t,e){return[new jt("step",((i,n)=>le(t,e(),n))),new jt("turnLeft",((i,n)=>he(t,e(),n))),new jt("pick",((i,n)=>ce(t,e(),n))),new jt("put",((i,n)=>ue(t,e(),n))),new jt("wall",((e,i)=>this.booleanToNumber(de(t)))),new jt("sign",((e,i)=>this.booleanToNumber(me(t)))),new jt("north",((e,i)=>this.booleanToNumber(pe(t)))),new jt("south",((e,i)=>this.booleanToNumber(ge(t)))),new jt("east",((e,i)=>this.booleanToNumber(we(t)))),new jt("west",((e,i)=>this.booleanToNumber(Te(t)))),new jt("home",((e,i)=>this.booleanToNumber(ke(t))))]}static booleanToNumber(t){return t?1:0}}karel=s})();